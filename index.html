<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <style>
        :root {
            --primary-blue: #007bff;
            --primary-green: #28a745;
            --primary-red: #dc3545;
            --primary-orange: #ff5722;
            --primary-purple: #8a2be2;
            --secondary-gray: #6c757d;
            --dark-gray: #343a40;
            --light-gray-bg: #f8f9fa;
            --border-color: #e0e0e0;
            --shadow-light: rgba(0, 0, 0, 0.08);
            --shadow-medium: rgba(0, 0, 0, 0.15);
            --border-radius: 8px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            color: var(--dark-gray);
        }
        .container {
            background-color: #ffffff;
            padding: 35px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px var(--shadow-light);
            text-align: center;
            max-width: 750px; /* Slightly wider */
            width: 90%;
            border: 1px solid var(--border-color);
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 700;
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 40px; /* More vertical space */
            flex-wrap: wrap;
        }
        button {
            padding: 14px 28px; /* Larger hit area */
            font-size: 1.05em;
            font-weight: 600;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.15s ease, box-shadow 0.2s ease;
            box-shadow: 0 3px 6px var(--shadow-light);
            flex-grow: 1; /* Allow buttons to grow */
            max-width: 200px; /* Limit button width */
        }
        button:hover:not(:disabled) {
            transform: translateY(-3px); /* More pronounced lift */
            box-shadow: 0 6px 12px var(--shadow-medium);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.7;
            transform: none; /* No lift when disabled */
            box-shadow: none;
        }

        /* Specific Button Colors */
        #togglePingButton { background-color: var(--secondary-gray); }
        #togglePingButton.active { background-color: var(--primary-red); }
        #manualPingButton { background-color: var(--primary-green); }
        #heartbeatPingButton { background-color: var(--primary-orange); }
        #heartbeatPingButton.active { background-color: #d84315; } /* Darker orange-red */
        #grafanaLinkButton { background-color: #f7a81b; } /* Grafana orange */
        #prometheusLinkButton { background-color: #4CAF50; } /* Prometheus green */

        /* Status and Countdown Group */
        .status-group {
            display: grid; /* Use grid for better alignment */
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Responsive grid */
            gap: 15px;
            margin-bottom: 30px;
            width: 100%;
        }
        .status-item {
            font-size: 0.95em;
            color: var(--dark-gray);
            padding: 12px 20px;
            border-radius: var(--border-radius);
            background-color: var(--light-gray-bg);
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px var(--shadow-light);
        }
        .status-item.active {
            background-color: #e6ffe6; /* Light green for active */
            border-color: #a3e6a3;
        }
        .status-item.active-red { /* For heartbeat active, different color */
            background-color: #ffe6e6; /* Light red */
            border-color: #ffb3b3;
        }
        .status-label {
            font-weight: 700; /* Bolder label */
            color: #2c3e50;
        }
        #autoPingCountdown {
            font-size: 1.1em;
            font-weight: 700;
            color: #d17a00; /* Consistent orange for countdown */
        }
        /* End Status and Countdown Group */

        /* Individual Output Areas */
        .ping-result-container {
            margin-top: 25px;
            width: 100%;
            text-align: left;
            border-top: 1px solid var(--border-color);
            padding-top: 25px;
        }
        .ping-result-display-label {
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
            color: var(--dark-gray);
            font-size: 1.05em;
        }
        .ping-result-display-wrapper {
            margin-bottom: 20px; /* Space between results */
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            background-color: var(--light-gray-bg);
            font-size: 0.9em;
            min-height: 40px; /* More vertical space for content */
            display: flex;
            align-items: center;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Subtle inner shadow */
        }
        /* Persona Colors for Output */
        .robot-ping-result { border-left: 5px solid var(--primary-purple); } /* Left border color */
        .human-ping-result { border-left: 5px solid var(--primary-blue); }
        .heartbeat-ping-result { border-left: 5px solid var(--primary-red); }

        .robot-ping-result > span.persona-label { color: var(--primary-purple); }
        .human-ping-result > span.persona-label { color: var(--primary-blue); }
        .heartbeat-ping-result > span.persona-label { color: var(--primary-red); }

        /* End Individual Output Areas */

        #history-section {
            margin-top: 30px;
            text-align: left;
            width: 100%;
            border-top: 1px solid var(--border-color);
            padding-top: 25px;
        }
        #history-section h2 {
            font-size: 1.8em;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 700;
        }
        #history-list {
            list-style: none;
            padding: 0;
            max-height: 300px; /* Increased history height */
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: #fdfdfd;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        #history-list li {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0; /* Lighter separator */
            font-size: 0.9em;
            color: #555;
            display: flex;
            align-items: flex-start;
            word-break: break-word; /* Ensure long messages wrap */
        }
        #history-list li:last-child {
            border-bottom: none;
        }
        .timestamp {
            font-weight: 600;
            color: #777; /* Softer color for timestamp */
            margin-right: 20px;
            flex-shrink: 0;
            min-width: 160px; /* Ensure timestamp has enough space */
        }
        /* Persona labels inside history list */
        .history-persona-label.robot-label { color: var(--primary-purple); }
        .history-persona-label.human-label { color: var(--primary-blue); }
        .history-persona-label.heartbeat-label { color: var(--primary-red); }
    </style>
</head>
<body>
    <div class="container">
        <h1>{{.Title}}</h1>
        <div class="button-group">
            <button id="togglePingButton">Start Auto-Ping ü§ñ</button>
            <button id="manualPingButton">Manual Ping üßë‚Äçüíª</button>
            <button id="heartbeatPingButton">Start Heartbeat üíñ</button>
            <button id="grafanaLinkButton">Grafana üìä</button>
            <button id="prometheusLinkButton">Prometheus üìà</button>
        </div>

        <div class="status-group">
            <div class="status-item" id="autoPingStatusItem">
                <span class="status-label">Auto-Ping:</span> <span id="ping-status">Stopped</span>
            </div>
            <div class="status-item" id="heartbeatStatusItem">
                <span class="status-label">Heartbeat:</span> <span id="heartbeat-status">Stopped</span>
            </div>
            <div class="status-item">
                <span class="status-label">Next Auto-Ping:</span> <span id="autoPingCountdown"></span>
            </div>
        </div>

        <div class="ping-result-container">
            <span class="ping-result-display-label robot-label">Last Robot Ping Result:</span>
            <div class="ping-result-display-wrapper" id="autoPingOutput"></div>

            <span class="ping-result-display-label human-label">Last Human Ping Result:</span>
            <div class="ping-result-display-wrapper" id="manualPingOutput"></div>

            <span class="ping-result-display-label heartbeat-label">Last Heartbeat Ping Result:</span>
            <div class="ping-result-display-wrapper" id="heartbeatPingOutput"></div>
        </div>

        <div id="history-section">
            <h2>Ping History</h2>
            <ul id="history-list">
                </ul>
        </div>
    </div>

    <script>
        // DOM Elements
        const togglePingButton = document.getElementById('togglePingButton');
        const manualPingButton = document.getElementById('manualPingButton');
        const heartbeatPingButton = document.getElementById('heartbeatPingButton');
        const grafanaLinkButton = document.getElementById('grafanaLinkButton');
        const prometheusLinkButton = document.getElementById('prometheusLinkButton');
        const pingStatusText = document.getElementById('ping-status');
        const heartbeatStatusText = document.getElementById('heartbeat-status');

        // Status Item wrappers for class toggling
        const autoPingStatusItem = document.getElementById('autoPingStatusItem');
        const heartbeatStatusItem = document.getElementById('heartbeatStatusItem');

        const autoPingCountdownDiv = document.getElementById('autoPingCountdown');

        // Dedicated output divs
        const autoPingOutputDiv = document.getElementById('autoPingOutput');
        const manualPingOutputDiv = document.getElementById('manualPingOutput');
        const heartbeatPingOutputDiv = document.getElementById('heartbeatPingOutput');
        
        const historyList = document.getElementById('history-list');

        // Auto-Ping State and Timers
        let isAutoPinging = false;
        let autoPingTimeoutId;
        let autoPingCountdownIntervalId;
        let nextAutoPingScheduledTime;
        const AUTO_MIN_INTERVAL = 60000;  // 1 minute
        const AUTO_MAX_INTERVAL = 300000; // 5 minutes

        // Heartbeat State and Timers
        let isHeartbeatPinging = false;
        let heartbeatIntervalId;
        const HEARTBEAT_INTERVAL = 1000; // 1 beat per second

        // --- Core Ping Function ---
        async function performPingAndRecord(persona = "Human") {
            const personaLabel = persona === "Robot" ? "ü§ñ Robot Ping" :
                                 persona === "Human" ? "üßë‚Äçüíª Human Ping" :
                                 "üíñ Heartbeat Ping";
            
            // Get the specific output div based on persona
            const currentOutputDivToUpdate = persona === "Robot" ? autoPingOutputDiv :
                                             persona === "Human" ? manualPingOutputDiv :
                                             heartbeatPingOutputDiv;
            
            const labelClass = persona === "Robot" ? "robot-label" :
                               persona === "Human" ? "human-label" :
                               "heartbeat-label";

            // Set loading state
            currentOutputDivToUpdate.innerHTML = `<span class="${labelClass}">${personaLabel}:</span> Pinging...`;
            
            // Disable manual button while pinging
            if (persona === "Human") {
                manualPingButton.disabled = true;
                manualPingButton.textContent = 'Pinging...';
            }

            const startTime = new Date();

            try {
                const response = await fetch('/ping');
                const text = await response.text();

                if (response.ok) {
                    currentOutputDivToUpdate.innerHTML = `<span class="${labelClass}">${personaLabel}:</span> Server responded with "<strong>${text}</strong>"`;
                    addHistoryEntry(startTime, `<span class="${labelClass} history-persona-label">${personaLabel}:</span> Server responded with "<strong>${text}</strong>"`);
                } else {
                    currentOutputDivToUpdate.innerHTML = `<span class="${labelClass}">${personaLabel}:</span> Error: ${response.status} ${response.statusText}`;
                    console.error('Server responded with an error:', response.status, response.statusText);
                    addHistoryEntry(startTime, `<span class="${labelClass} history-persona-label">${personaLabel}:</span> <span style="color: red;">Error: ${response.status} ${response.statusText}</span>`);
                }
            } catch (error) {
                currentOutputDivToUpdate.innerHTML = `<span class="${labelClass}">${personaLabel}:</span> Network Error: ${error.message}`;
                console.error('Could not fetch ping response:', error);
                addHistoryEntry(startTime, `<span class="${labelClass} history-persona-label">${personaLabel}:</span> <span style="color: red;">Network Error: ${error.message}</span>`);
            } finally {
                // Re-enable manual button after ping completes
                if (persona === "Human") {
                    manualPingButton.disabled = false;
                    manualPingButton.textContent = 'Manual Ping üßë‚Äçüíª';
                }
            }
        }

        function addHistoryEntry(timestampObj, messageHtml) {
            const timestamp = timestampObj.toLocaleString();
            const newHistoryItem = document.createElement('li');
            newHistoryItem.innerHTML = `<span class="timestamp">${timestamp}:</span> ${messageHtml}`;
            historyList.prepend(newHistoryItem);
            historyList.scrollTop = 0;
        }

        // --- Auto-Ping Logic ---
        function updateAutoPingCountdownDisplay() {
            if (!isAutoPinging || !nextAutoPingScheduledTime) {
                autoPingCountdownDiv.textContent = '';
                return;
            }

            const now = Date.now();
            const timeRemainingMs = nextAutoPingScheduledTime - now;

            if (timeRemainingMs <= 0) {
                autoPingCountdownDiv.textContent = 'Pinging now...';
            } else {
                const secondsRemaining = Math.ceil(timeRemainingMs / 1000);
                const minutes = Math.floor(secondsRemaining / 60);
                const seconds = secondsRemaining % 60;
                autoPingCountdownDiv.textContent = `${minutes}m ${seconds}s`;
            }
        }

        async function scheduleNextAutoPingCycle() {
            if (!isAutoPinging) {
                clearTimeout(autoPingTimeoutId);
                clearInterval(autoPingCountdownIntervalId);
                autoPingCountdownDiv.textContent = '';
                return;
            }

            await performPingAndRecord("Robot");

            const randomDelay = Math.random() * (AUTO_MAX_INTERVAL - AUTO_MIN_INTERVAL) + AUTO_MIN_INTERVAL;
            nextAutoPingScheduledTime = Date.now() + randomDelay;

            clearInterval(autoPingCountdownIntervalId); // Clear existing interval if any
            autoPingCountdownIntervalId = setInterval(updateAutoPingCountdownDisplay, 1000);
            updateAutoPingCountdownDisplay(); // Call immediately for initial display

            autoPingTimeoutId = setTimeout(() => {
                scheduleNextAutoPingCycle();
            }, randomDelay);
        }

        togglePingButton.addEventListener('click', () => {
            isAutoPinging = !isAutoPinging;

            if (isAutoPinging) {
                togglePingButton.textContent = 'Stop Auto-Ping ü§ñ';
                togglePingButton.classList.add('active');
                autoPingStatusItem.classList.add('active'); // Activate status-item
                pingStatusText.textContent = `Running (Interval: ${AUTO_MIN_INTERVAL/60000}-${AUTO_MAX_INTERVAL/60000} min)`;
                scheduleNextAutoPingCycle();
            } else {
                clearTimeout(autoPingTimeoutId);
                clearInterval(autoPingCountdownIntervalId);
                togglePingButton.textContent = 'Start Auto-Ping ü§ñ';
                togglePingButton.classList.remove('active');
                autoPingStatusItem.classList.remove('active'); // Deactivate status-item
                pingStatusText.textContent = 'Stopped';
                autoPingCountdownDiv.textContent = ''; // Clear countdown when stopped
            }
        });

        // --- Manual Ping Logic ---
        manualPingButton.addEventListener('click', async () => {
            await performPingAndRecord("Human");
        });

        // --- Heartbeat Ping Logic ---
        heartbeatPingButton.addEventListener('click', () => {
            isHeartbeatPinging = !isHeartbeatPinging;

            if (isHeartbeatPinging) {
                heartbeatPingButton.textContent = 'Stop Heartbeat üíñ';
                heartbeatPingButton.classList.add('active');
                heartbeatStatusItem.classList.add('active-red'); // Activate status-item with red
                heartbeatStatusText.textContent = `Running (~${HEARTBEAT_INTERVAL/1000}s interval)`;
                
                performPingAndRecord("Heartbeat");
                heartbeatIntervalId = setInterval(() => {
                    performPingAndRecord("Heartbeat");
                }, HEARTBEAT_INTERVAL);
            } else {
                clearInterval(heartbeatIntervalId);
                heartbeatPingButton.textContent = 'Start Heartbeat üíñ';
                heartbeatPingButton.classList.remove('active');
                heartbeatStatusItem.classList.remove('active-red'); // Deactivate status-item
                heartbeatStatusText.textContent = 'Stopped';
            }
        });

        // Event listener for the Grafana link button
        grafanaLinkButton.addEventListener('click', () => {
            window.open('http://localhost:3000/dashboards', '_blank');
        });

        // Event listener for the Prometheus link button
        prometheusLinkButton.addEventListener('click', () => {
            window.open('http://localhost:9090/', '_blank');
        });
    </script>
</body>
</html>